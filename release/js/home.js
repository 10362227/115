!function(){"use strict";var e=new class extends class{constructor(){this._listeners={}}on(e,t){(this._listeners[e]=this._listeners[e]||[]).push(t)}trigger(e,t){(this._listeners[e]||[]).forEach((e=>e(t)))}off(e){delete this._listeners[e]}}{constructor(){super(),this.defaultRPC=[{name:"ARIA2 RPC",url:"http://localhost:6800/jsonrpc"}],this.defaultUserAgent="Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36 115Browser/5.1.3",this.defaultReferer="https://115.com/",this.defaultConfigData={rpcList:this.defaultRPC,configSync:!1,sha1Check:!1,vip:!0,small:!1,interval:300,downloadPath:"",userAgent:this.defaultUserAgent,browserUserAgent:!0,referer:this.defaultReferer,headers:""},this.configData={},this.on("initConfigData",this.init.bind(this)),this.on("setConfigData",this.set.bind(this)),this.on("clearConfigData",this.clear.bind(this))}init(){chrome.storage.sync.get(null,(e=>{for(const t in e)chrome.storage.local.set({key:e[t]},(()=>{console.log("chrome first local set: %s, %s",t,e[t])}))})),chrome.storage.local.get(null,(e=>{this.configData=Object.assign({},this.defaultConfigData,e),this.trigger("updateView",this.configData)}))}getConfigData(e=null){return e?this.configData[e]:this.configData}set(e){this.configData=e,this.save(e),this.trigger("updateView",e)}save(e){for(const t in e)chrome.storage.local.set({[t]:e[t]},(()=>{console.log("chrome local set: %s, %s",t,e[t])})),!0===e.configSync&&chrome.storage.sync.set({[t]:e[t]},(()=>{console.log("chrome sync set: %s, %s",t,e[t])}))}clear(){chrome.storage.sync.clear(),chrome.storage.local.clear(),this.configData=this.defaultConfigData,this.trigger("updateView",this.configData)}};var t=new class{constructor(){this.cookies={}}httpSend({url:e,options:t},n,s){fetch(e,t).then((e=>{e.ok?e.json().then((e=>{n(e)})):s(e)})).catch((e=>{s(e)}))}getConfigData(t=null){return e.getConfigData(t)}objectToQueryString(e){return Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&")}sendToBackground(e,t,n){chrome.runtime.sendMessage({method:e,data:t},n)}showToast(e,t){window.postMessage({type:"showToast",data:{message:e,type:t}},location.origin)}getHashParameter(e){const t=window.location.hash.substr(1);return new URLSearchParams(t).get(e)}formatCookies(){const e=[];for(const t in this.cookies)e.push(`${t}=${this.cookies[t]}`);return e.join("; ")}getHeader(e="RPC"){const t=[],n=this.getConfigData("browserUserAgent");let s=this.getConfigData("userAgent");if(n){const e=navigator.userAgent;e&&e.length&&(s=e)}t.push(`User-Agent: ${s}`),t.push(`Referer: ${this.getConfigData("referer")}`),t.push(`Cookie: ${this.formatCookies()}`);const i=this.getConfigData("headers");return i&&i.split("\n").forEach((e=>{t.push(e)})),"RPC"===e?t:"aria2Cmd"===e?t.map((e=>`--header ${JSON.stringify(e)}`)).join(" "):"aria2c"===e?t.map((e=>` header=${e}`)).join("\n"):"idm"===e?t.map((e=>{const t=e.split(": ");return`${t[0].toLowerCase()}: ${t[1]}`})).join("\r\n"):void 0}parseURL(e){const t=new URL(e);let n=t.username?`${t.username}:${decodeURI(t.password)}`:null;n&&(n.includes("token:")||(n=`Basic ${btoa(n)}`));const s=t.hash.substr(1),i={},o=new URLSearchParams(s);for(const e of o){const[t,n]=e;i[t]=n.length?n:"enabled"}return{authStr:n,path:t.origin+t.pathname,options:i}}generateParameter(e,t,n){e&&e.startsWith("token")&&n.params.unshift(e);const s={url:t,options:{method:"POST",headers:{},body:JSON.stringify(n)}};return e&&e.startsWith("Basic")&&(s.options.headers.Authorization=e),s}getVersion(e,t){const{authStr:n,path:s}=this.parseURL(e);this.sendToBackground("rpcVersion",this.generateParameter(n,s,{jsonrpc:"2.0",method:"aria2.getVersion",id:1,params:[]}),(e=>{t.innerText=e?`Aria2版本为: ${e}`:"错误,请查看是否开启Aria2"}))}copyText(e){navigator.clipboard?navigator.clipboard.writeText(e).then((()=>{this.showToast("拷贝成功~","inf")})).catch((()=>{this.showToast("拷贝失败 QAQ","err")})):this.showToast("拷贝失败 QAQ","err")}requestCookies(e){return new Promise((t=>{this.sendToBackground("getCookies",e,(e=>{t(e)}))}))}aria2RPCMode(e,t){const{authStr:n,path:s,options:i}=this.parseURL(e);this.getConfigData("small")&&t.sort(((e,t)=>e.size-t.size)),t.forEach((e=>{this.cookies=e.cookies;const t={jsonrpc:"2.0",method:"aria2.addUri",id:(new Date).getTime(),params:[[e.link],{out:e.name,header:this.getHeader()}]},o=this.getConfigData("sha1Check"),a=t.params[1],r=this.getConfigData("downloadPath");if(r&&(a.dir=r),o&&(a.checksum=`sha-1=${e.sha1}`),i)for(const e in i)a[e]=i[e];this.sendToBackground("rpcData",this.generateParameter(n,s,t),(e=>{e?this.showToast("下载成功!赶紧去看看吧~","inf"):this.showToast("下载失败!是不是没有开启Aria2?","err")}))}))}aria2TXTMode(e){const t=[],n=[],s=[],i=[],o="data:text/plain;charset=utf-8,";e.forEach((e=>{this.cookies=e.cookies;let o=`aria2c -c -s10 -k1M -x16 --enable-rpc=false -o ${JSON.stringify(e.name)} ${this.getHeader("aria2Cmd")} ${JSON.stringify(e.link)}`,a=[e.link,this.getHeader("aria2c"),` out=${e.name}`].join("\n");this.getConfigData("sha1Check")&&(o+=` --checksum=sha-1=${e.sha1}`,a+=`\n checksum=sha-1=${e.sha1}`),t.push(o),n.push(a);const r=["<",e.link,this.getHeader("idm"),">"].join("\r\n");s.push(r),i.push(e.link)})),document.querySelector("#aria2CmdTxt").value=`${t.join("\n")}`,document.querySelector("#aria2Txt").href=`${o}${encodeURIComponent(n.join("\n"))}`,document.querySelector("#idmTxt").href=`${o}${encodeURIComponent(s.join("\r\n")+"\r\n")}`,document.querySelector("#downloadLinkTxt").href=`${o}${encodeURIComponent(i.join("\n"))}`,document.querySelector("#copyDownloadLinkTxt").dataset.link=i.join("\n")}};var n=new class{constructor(){this.version="0.5.0",this.updateDate="2022/07/03",e.on("updateView",(e=>{this.updateSetting(e),this.updateMenu(e)}))}init(){this.context=document.querySelector('iframe[rel="wangpan"]').contentDocument,this.addSettingUI(),this.addTextExport(),e.trigger("initConfigData")}addMenu(e,t){if(!e)return;e.insertAdjacentHTML(t,'\n      <div id="exportMenu" class="export">\n        <a class="export-button">导出下载</a>\n        <div id="aria2List" class="export-menu">\n          <a class="export-menu-item" id="batchOpen" href="javascript:void(0);">批量打开</a>\n          <a class="export-menu-item" id="aria2Text" href="javascript:void(0);">文本导出</a>\n          <a class="export-menu-item" id="settingButton" href="javascript:void(0);">设置</a>\n        </div>\n      </div>');const n=this.context.querySelector("#exportMenu");n.addEventListener("mouseenter",(()=>{n.classList.add("open-o")})),n.addEventListener("mouseleave",(()=>{n.classList.remove("open-o")}));const s=this.context.querySelector("#settingButton"),i=document.querySelector("#settingMenu");s.addEventListener("click",(e=>{i.classList.add("open-o")}));this.context.querySelector("#aria2List").addEventListener("mousedown",(e=>{e.stopPropagation()}))}addContextMenuRPCSectionWithCallback(e){const t=t=>{t.insertAdjacentHTML("beforebegin",'<div class="cell" id="more-menu-rpc-section"><ul></ul></div>'),this.mostRecentConfigData&&this.updateMenu(this.mostRecentConfigData),e&&e()},n=this.context.querySelector("body > .context-menu .cell");if(n)t(n);else if("MutationObserver"in window){const e=this.context.querySelector("body"),n=new MutationObserver((e=>{const s=this.context.querySelector("body > .context-menu .cell");s&&(n.disconnect(),t(s))}));n.observe(e,{childList:!0})}}resetMenu(){this.context.querySelectorAll("#more-menu-rpc-section li").forEach((e=>{e.remove()})),this.context.querySelectorAll(".rpc-button").forEach((e=>{e.remove()}))}updateMenu(e){this.resetMenu();const{rpcList:t}=e;let n="",s="";t.forEach((e=>{const t=`<a class="export-menu-item rpc-button" href="javascript:void(0);" data-url=${e.url}>${e.name}</a>`;n+=t,s+=`<li><a href="javascript:void(0);" data-url=${e.url}>${e.name}</a></li>`})),this.context.querySelector("#aria2List").insertAdjacentHTML("afterbegin",n);const i=this.context.querySelector("#more-menu-rpc-section ul");i&&i.insertAdjacentHTML("afterbegin",s)}addTextExport(){document.body.insertAdjacentHTML("beforeend",'\n      <div id="textMenu" class="modal text-menu">\n        <div class="modal-inner">\n          <div class="modal-header">\n            <div class="modal-title">文本导出</div>\n            <div class="modal-close">×</div>\n          </div>\n          <div class="modal-body">\n            <div class="text-menu-row">\n              <a class="text-menu-button" href="javascript:void(0);" id="aria2Txt" download="aria2c.down">存为Aria2文件</a>\n              <a class="text-menu-button" href="javascript:void(0);" id="idmTxt" download="idm.ef2">存为IDM文件</a>\n              <a class="text-menu-button" href="javascript:void(0);" id="downloadLinkTxt" download="link.txt">保存下载链接</a>\n              <a class="text-menu-button" href="javascript:void(0);" id="copyDownloadLinkTxt">拷贝下载链接</a>\n            </div>\n            <div class="text-menu-row">\n              <textarea class="text-menu-textarea" type="textarea" wrap="off" spellcheck="false" id="aria2CmdTxt"></textarea>\n            </div>\n          </div>\n        </div>\n      </div>');const e=document.querySelector("#textMenu"),n=e.querySelector(".modal-close"),s=e.querySelector("#copyDownloadLinkTxt");s.addEventListener("click",(()=>{t.copyText(s.dataset.link)})),n.addEventListener("click",(()=>{e.classList.remove("open-o"),this.resetTextExport()}))}resetTextExport(){const e=document.querySelector("#textMenu");e.querySelector("#aria2Txt").href="",e.querySelector("#idmTxt").href="",e.querySelector("#downloadLinkTxt").href="",e.querySelector("#aria2CmdTxt").value="",e.querySelector("#copyDownloadLinkTxt").dataset.link=""}addSettingUI(){const n=`\n      <div id="settingMenu" class="modal setting-menu">\n        <div class="modal-inner">\n          <div class="modal-header">\n            <div class="modal-title">导出设置</div>\n            <div class="modal-close">×</div>\n          </div>\n          <div class="modal-body">\n            <div class="setting-menu-message">\n              <label class="setting-menu-label orange-o" id="message"></label>\n            </div>\n            <div class="setting-menu-row rpc-s">\n              <div class="setting-menu-name">\n                <input class="setting-menu-input name-s" spellcheck="false">\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input url-s" spellcheck="false">\n                <a class="setting-menu-button" id="addRPC" href="javascript:void(0);">添加RPC地址</a>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">配置同步</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox configSync-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">SHA1校验</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox sha1Check-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">115会员</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox vip-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">小文件优先</label>\n              </div>\n              <div class="setting-menu-value">\n                <input type="checkbox" class="setting-menu-checkbox small-s">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">递归下载间隔</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input small-o interval-s" type="number" spellcheck="false">\n                <label class="setting-menu-label">(单位:毫秒)</label>\n                <a class="setting-menu-button version-s" id="testAria2" href="javascript:void(0);">测试连接，成功显示版本号</a>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">下载路径</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input downloadPath-s" placeholder="只能设置为绝对路径" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">User-Agent</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input userAgent-s" spellcheck="false">\n                <label class="setting-menu-label"></label>\n                <input type="checkbox" class="setting-menu-checkbox browser-userAgent-s">\n                <label class="setting-menu-label for-checkbox">使用浏览器 UA</label>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">Referer</label>\n              </div>\n              <div class="setting-menu-value">\n                <input class="setting-menu-input referer-s" spellcheck="false">\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n            <div class="setting-menu-row">\n              <div class="setting-menu-name">\n                <label class="setting-menu-label">Headers</label>\n              </div>\n              <div class="setting-menu-value">\n                <textarea class="setting-menu-input textarea-o headers-s" type="textarea" spellcheck="false"></textarea>\n              </div>\n            </div>\x3c!-- /.setting-menu-row --\x3e\n          </div>\x3c!-- /.setting-menu-body --\x3e\n          <div class="modal-footer">\n            <div class="setting-menu-copyright">\n              <div class="setting-menu-item">\n                <label class="setting-menu-label">&copy; Copyright</label>\n                <a class="setting-menu-link" href="https://github.com/acgotaku/115" target="_blank">雪月秋水</a>\n              </div>\n              <div class="setting-menu-item">\n                <label class="setting-menu-label">Version: ${this.version}</label>\n                <label class="setting-menu-label">Update date: ${this.updateDate}</label>\n              </div>\n            </div>\x3c!-- /.setting-menu-copyright --\x3e\n            <div class="setting-menu-operate">\n              <a class="setting-menu-button large-o blue-o" id="apply" href="javascript:void(0);">应用</a>\n              <a class="setting-menu-button large-o" id="reset" href="javascript:void(0);">重置</a>\n            </div>\n          </div>\n        </div>\n      </div>`;document.body.insertAdjacentHTML("beforeend",n);const s=document.querySelector("#settingMenu");s.querySelector(".modal-close").addEventListener("click",(()=>{s.classList.remove("open-o"),this.resetSetting()}));document.querySelector("#addRPC").addEventListener("click",(()=>{const e=document.querySelectorAll(".rpc-s");Array.from(e).pop().insertAdjacentHTML("afterend",'\n        <div class="setting-menu-row rpc-s">\n          <div class="setting-menu-name">\n            <input class="setting-menu-input name-s" spellcheck="false">\n          </div>\n          <div class="setting-menu-value">\n            <input class="setting-menu-input url-s" spellcheck="false">\n          </div>\n        </div>\x3c!-- /.setting-menu-row --\x3e')}));const i=document.querySelector("#apply"),o=document.querySelector("#message");i.addEventListener("click",(()=>{this.saveSetting(),o.innerText="设置已保存"}));document.querySelector("#reset").addEventListener("click",(()=>{e.trigger("clearConfigData"),o.innerText="设置已重置"}));const a=document.querySelector("#testAria2");a.addEventListener("click",(()=>{t.getVersion(e.getConfigData("rpcList")[0].url,a)}));const r=document.querySelector(".userAgent-s"),c=document.querySelector(".browser-userAgent-s");c.addEventListener("change",(()=>{r.disabled=c.checked}))}resetSetting(){document.querySelector("#message").innerText="";document.querySelector("#testAria2").innerText="测试连接，成功显示版本号"}updateSetting(e){const{rpcList:t,configSync:n,sha1Check:s,vip:i,small:o,interval:a,downloadPath:r,userAgent:c,browserUserAgent:l,referer:d,headers:u}=e;document.querySelectorAll(".rpc-s").forEach(((e,t)=>{0!==t&&e.remove()})),t.forEach(((e,t)=>{const n=document.querySelectorAll(".rpc-s");if(0===t)n[t].querySelector(".name-s").value=e.name,n[t].querySelector(".url-s").value=e.url;else{const t=`\n          <div class="setting-menu-row rpc-s">\n            <div class="setting-menu-name">\n              <input class="setting-menu-input name-s" value="${e.name}" spellcheck="false">\n            </div>\n            <div class="setting-menu-value">\n              <input class="setting-menu-input url-s" value="${e.url}" spellcheck="false">\n            </div>\n          </div>\x3c!-- /.setting-menu-row --\x3e`;Array.from(n).pop().insertAdjacentHTML("afterend",t)}})),document.querySelector(".configSync-s").checked=n,document.querySelector(".sha1Check-s").checked=s,document.querySelector(".vip-s").checked=i,document.querySelector(".small-s").checked=o,document.querySelector(".interval-s").value=a,document.querySelector(".downloadPath-s").value=r,document.querySelector(".userAgent-s").value=c,document.querySelector(".userAgent-s").disabled=l,document.querySelector(".browser-userAgent-s").checked=l,document.querySelector(".referer-s").value=d,document.querySelector(".headers-s").value=u,this.mostRecentConfigData=e}saveSetting(){const t=document.querySelectorAll(".rpc-s"),n={rpcList:Array.from(t).map((e=>{const t=e.querySelector(".name-s").value,n=e.querySelector(".url-s").value;return t&&n?{name:t,url:n}:null})).filter((e=>e)),configSync:document.querySelector(".configSync-s").checked,sha1Check:document.querySelector(".sha1Check-s").checked,vip:document.querySelector(".vip-s").checked,small:document.querySelector(".small-s").checked,interval:document.querySelector(".interval-s").value,downloadPath:document.querySelector(".downloadPath-s").value,userAgent:document.querySelector(".userAgent-s").value,browserUserAgent:document.querySelector(".browser-userAgent-s").checked,referer:document.querySelector(".referer-s").value,headers:document.querySelector(".headers-s").value};e.trigger("setConfigData",n)}};var s,i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},o={exports:{}};s=o,function(e){function t(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function n(e,n,s,i,o,a){return t((r=t(t(n,e),t(i,a)))<<(c=o)|r>>>32-c,s);var r,c}function i(e,t,s,i,o,a,r){return n(t&s|~t&i,e,t,o,a,r)}function o(e,t,s,i,o,a,r){return n(t&i|s&~i,e,t,o,a,r)}function a(e,t,s,i,o,a,r){return n(t^s^i,e,t,o,a,r)}function r(e,t,s,i,o,a,r){return n(s^(t|~i),e,t,o,a,r)}function c(e,n){var s,c,l,d,u;e[n>>5]|=128<<n%32,e[14+(n+64>>>9<<4)]=n;var h=1732584193,m=-271733879,g=-1732584194,p=271733878;for(s=0;s<e.length;s+=16)c=h,l=m,d=g,u=p,h=i(h,m,g,p,e[s],7,-680876936),p=i(p,h,m,g,e[s+1],12,-389564586),g=i(g,p,h,m,e[s+2],17,606105819),m=i(m,g,p,h,e[s+3],22,-1044525330),h=i(h,m,g,p,e[s+4],7,-176418897),p=i(p,h,m,g,e[s+5],12,1200080426),g=i(g,p,h,m,e[s+6],17,-1473231341),m=i(m,g,p,h,e[s+7],22,-45705983),h=i(h,m,g,p,e[s+8],7,1770035416),p=i(p,h,m,g,e[s+9],12,-1958414417),g=i(g,p,h,m,e[s+10],17,-42063),m=i(m,g,p,h,e[s+11],22,-1990404162),h=i(h,m,g,p,e[s+12],7,1804603682),p=i(p,h,m,g,e[s+13],12,-40341101),g=i(g,p,h,m,e[s+14],17,-1502002290),h=o(h,m=i(m,g,p,h,e[s+15],22,1236535329),g,p,e[s+1],5,-165796510),p=o(p,h,m,g,e[s+6],9,-1069501632),g=o(g,p,h,m,e[s+11],14,643717713),m=o(m,g,p,h,e[s],20,-373897302),h=o(h,m,g,p,e[s+5],5,-701558691),p=o(p,h,m,g,e[s+10],9,38016083),g=o(g,p,h,m,e[s+15],14,-660478335),m=o(m,g,p,h,e[s+4],20,-405537848),h=o(h,m,g,p,e[s+9],5,568446438),p=o(p,h,m,g,e[s+14],9,-1019803690),g=o(g,p,h,m,e[s+3],14,-187363961),m=o(m,g,p,h,e[s+8],20,1163531501),h=o(h,m,g,p,e[s+13],5,-1444681467),p=o(p,h,m,g,e[s+2],9,-51403784),g=o(g,p,h,m,e[s+7],14,1735328473),h=a(h,m=o(m,g,p,h,e[s+12],20,-1926607734),g,p,e[s+5],4,-378558),p=a(p,h,m,g,e[s+8],11,-2022574463),g=a(g,p,h,m,e[s+11],16,1839030562),m=a(m,g,p,h,e[s+14],23,-35309556),h=a(h,m,g,p,e[s+1],4,-1530992060),p=a(p,h,m,g,e[s+4],11,1272893353),g=a(g,p,h,m,e[s+7],16,-155497632),m=a(m,g,p,h,e[s+10],23,-1094730640),h=a(h,m,g,p,e[s+13],4,681279174),p=a(p,h,m,g,e[s],11,-358537222),g=a(g,p,h,m,e[s+3],16,-722521979),m=a(m,g,p,h,e[s+6],23,76029189),h=a(h,m,g,p,e[s+9],4,-640364487),p=a(p,h,m,g,e[s+12],11,-421815835),g=a(g,p,h,m,e[s+15],16,530742520),h=r(h,m=a(m,g,p,h,e[s+2],23,-995338651),g,p,e[s],6,-198630844),p=r(p,h,m,g,e[s+7],10,1126891415),g=r(g,p,h,m,e[s+14],15,-1416354905),m=r(m,g,p,h,e[s+5],21,-57434055),h=r(h,m,g,p,e[s+12],6,1700485571),p=r(p,h,m,g,e[s+3],10,-1894986606),g=r(g,p,h,m,e[s+10],15,-1051523),m=r(m,g,p,h,e[s+1],21,-2054922799),h=r(h,m,g,p,e[s+8],6,1873313359),p=r(p,h,m,g,e[s+15],10,-30611744),g=r(g,p,h,m,e[s+6],15,-1560198380),m=r(m,g,p,h,e[s+13],21,1309151649),h=r(h,m,g,p,e[s+4],6,-145523070),p=r(p,h,m,g,e[s+11],10,-1120210379),g=r(g,p,h,m,e[s+2],15,718787259),m=r(m,g,p,h,e[s+9],21,-343485551),h=t(h,c),m=t(m,l),g=t(g,d),p=t(p,u);return[h,m,g,p]}function l(e){var t,n="",s=32*e.length;for(t=0;t<s;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function d(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function u(e){var t,n,s="0123456789abcdef",i="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}function h(e){return unescape(encodeURIComponent(e))}function m(e){return function(e){return l(c(d(e),8*e.length))}(h(e))}function g(e,t){return function(e,t){var n,s,i=d(e),o=[],a=[];for(o[15]=a[15]=void 0,i.length>16&&(i=c(i,8*e.length)),n=0;n<16;n+=1)o[n]=909522486^i[n],a[n]=1549556828^i[n];return s=c(o.concat(d(t)),512+8*t.length),l(c(a.concat(s),640))}(h(e),h(t))}function p(e,t,n){return t?n?g(t,e):u(g(t,e)):n?m(e):u(m(e))}s.exports?s.exports=p:e.md5=p}(i);var a=o.exports;var r=new class{constructor(){this.publicKey=new window.JSEncrypt,this.publicKey.setPublicKey("-----BEGIN RSA PUBLIC KEY-----\n    MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDR3rWmeYnRClwLBB0Rq0dlm8Mr\n    PmWpL5I23SzCFAoNpJX6Dn74dfb6y02YH15eO6XmeBHdc7ekEFJUIi+swganTokR\n    IVRRr/z16/3oh7ya22dcAqg191y+d6YDr4IGg/Q5587UKJMj35yQVXaeFXmLlFPo\n    kFiz4uPxhrB7BGqZbQIDAQAB\n    -----END RSA PUBLIC KEY-----"),this.privateKey=new window.JSEncrypt,this.privateKey.setPrivateKey("-----BEGIN RSA PRIVATE KEY-----\n    MIICXAIBAAKBgQCMgUJLwWb0kYdW6feyLvqgNHmwgeYYlocst8UckQ1+waTOKHFC\n    TVyRSb1eCKJZWaGa08mB5lEu/asruNo/HjFcKUvRF6n7nYzo5jO0li4IfGKdxso6\n    FJIUtAke8rA2PLOubH7nAjd/BV7TzZP2w0IlanZVS76n8gNDe75l8tonQQIDAQAB\n    AoGANwTasA2Awl5GT/t4WhbZX2iNClgjgRdYwWMI1aHbVfqADZZ6m0rt55qng63/\n    3NsjVByAuNQ2kB8XKxzMoZCyJNvnd78YuW3Zowqs6HgDUHk6T5CmRad0fvaVYi6t\n    viOkxtiPIuh4QrQ7NUhsLRtbH6d9s1KLCRDKhO23pGr9vtECQQDpjKYssF+kq9iy\n    A9WvXRjbY9+ca27YfarD9WVzWS2rFg8MsCbvCo9ebXcmju44QhCghQFIVXuebQ7Q\n    pydvqF0lAkEAmgLnib1XonYOxjVJM2jqy5zEGe6vzg8aSwKCYec14iiJKmEYcP4z\n    DSRms43hnQsp8M2ynjnsYCjyiegg+AZ87QJANuwwmAnSNDOFfjeQpPDLy6wtBeft\n    5VOIORUYiovKRZWmbGFwhn6BQL+VaafrNaezqUweBRi1PYiAF2l3yLZbUQJAf/nN\n    4Hz/pzYmzLlWnGugP5WCtnHKkJWoKZBqO2RfOBCq+hY4sxvn3BHVbXqGcXLnZPvo\n    YuaK7tTXxZSoYLEzeQJBAL8Mt3AkF1Gci5HOug6jT4s4Z+qDDrUXo9BlTwSWP90v\n    wlHF+mkTJpKd5Wacef0vV+xumqNorvLpIXWKwxNaoHM=\n    -----END RSA PRIVATE KEY-----"),this.kts=[240,229,105,174,191,220,191,90,26,69,232,190,125,166,115,136,222,143,231,196,69,218,134,148,155,105,146,11,106,184,241,122,56,6,60,149,38,109,44,86,0,112,86,156,54,56,98,118,47,155,95,15,242,254,253,45,112,156,134,68,143,61,20,39,113,147,138,228,14,193,72,174,220,52,127,207,254,178,127,246,85,154,70,200,235,55,119,164,224,107,114,147,126,81,203,241,55,239,173,42,222,238,249,201,57,107,50,161,186,53,177,184,190,218,120,115,248,32,213,39,4,90,111,253,94,114,57,207,59,156,43,87,92,249,124,75,123,210,18,102,204,119,9,166],this.keyS=[41,35,33,94],this.keyL=[66,218,19,186,120,118,141,55,232,238,4,145]}xor115Enc(e,t,n,s){let i,o,a,r,c,l,d,u;if(r=t%4,u=[],0!==r)for(i=o=0,c=r;c>=0?o<c:o>c;i=c>=0?++o:--o)u.push(e[i]^n[i%s]);for(i=a=l=r,d=t;l<=d?a<d:a>d;i=l<=d?++a:--a)u.push(e[i]^n[(i-r)%s]);return u}getkey(e,t){let n;return null!=t?(()=>{let s,i,o;for(o=[],n=s=0,i=e;i>=0?s<i:s>i;n=i>=0?++s:--s)o.push(t[n]+this.kts[e*n]&255^this.kts[e*(e-1-n)]);return o})():12===e?this.keyL.slice(0):this.keyS.slice(0)}asymEncode(e,t){let n,s,i,o,a;for(i=117,a="",n=s=0,o=Math.floor((t+i-1)/i);o>=0?s<o:s>o;n=o>=0?++s:--s)a+=window.atob(this.publicKey.encrypt(this.bytesToString(e.slice(n*i,Math.min((n+1)*i,t)))));return window.btoa(a)}asymDecode(e,t){let n,s,i,o,a;for(i=128,a="",n=s=0,o=Math.floor((t+i-1)/i);o>=0?s<o:s>o;n=o>=0?++s:--s)a+=this.privateKey.decrypt(window.btoa(this.bytesToString(e.slice(n*i,Math.min((n+1)*i,t)))));return this.stringToBytes(a)}symEncode(e,t,n,s){let i,o,a;return i=this.getkey(4,n),o=this.getkey(12,s),a=this.xor115Enc(e,t,i,4),a.reverse(),a=this.xor115Enc(a,t,o,12),a}symDecode(e,t,n,s){let i,o,a;return i=this.getkey(4,n),o=this.getkey(12,s),a=this.xor115Enc(e,t,o,12),a.reverse(),a=this.xor115Enc(a,t,i,4),a}bytesToString(e){let t,n,s,i;for(i="",n=0,s=e.length;n<s;n++)t=e[n],i+=String.fromCharCode(t);return i}stringToBytes(e){let t,n,s,i;for(i=[],t=n=0,s=e.length;s>=0?n<s:n>s;t=s>=0?++n:--n)i.push(e.charCodeAt(t));return i}encode(e,t){const n=this.stringToBytes(a(`!@###@#${t}DFDR@#@#`));let s=this.stringToBytes(e);return s=this.symEncode(s,s.length,n,null),s=n.slice(0,16).concat(s),{data:this.asymEncode(s,s.length),key:n}}decode(e,t){let n=this.stringToBytes(window.atob(e));return n=this.asymDecode(n,n.length),this.bytesToString(this.symDecode(n.slice(16),n.length-16,t,n.slice(0,16)))}};(new class extends class{constructor(e){this.listParameter=e,this.fileDownloadInfo=[],this.currentTaskId=0,this.completedCount=0,this.folders=[],this.files={}}start(e=300,t){this.interval=e,this.done=t,this.currentTaskId=(new Date).getTime(),this.getNextFile(this.currentTaskId)}reset(){this.fileDownloadInfo=[],this.currentTaskId=0,this.folders=[],this.files={},this.completedCount=0}addFolder(e){this.folders.push(e)}addFile(e){this.files[e.pick_code]=e}getNextFile(e){if(e===this.currentTaskId)if(0!==this.folders.length){this.completedCount++,t.showToast(`正在获取文件列表... ${this.completedCount}/${this.completedCount+this.folders.length-1}`,"inf");const n=this.folders.pop();this.listParameter.search.cid=n.cate_id,t.sendToBackground("fetch",{url:`${this.listParameter.url}${t.objectToQueryString(this.listParameter.search)}`,options:this.listParameter.options},(t=>{setTimeout((()=>this.getNextFile(e)),this.interval);const s=n.path+t.path[t.path.length-1].name+"/";t.data.forEach((e=>{e.sha?this.files[e.pc]={path:s,isdir:!1,sha1:e.sha,pick_code:e.pc}:this.folders.push({cate_id:e.cid,path:s})}))}))}else 0!==this.files.length?(t.showToast("正在获取下载地址...","inf"),this.getFiles(this.files).then((()=>{this.done(this.fileDownloadInfo)}))):(t.showToast("一个文件都没有哦...","war"),this.reset())}getFiles(e){throw new Error("subclass should implement this method!")}}{constructor(){super({search:{aid:1,limit:1e3,show_dir:1,cid:""},url:`${location.protocol}//webapi.115.com/files?`,options:{credentials:"include",method:"GET"}}),this.mode="RPC",this.rpcURL="http://localhost:6800/jsonrpc",this.iframe=document.querySelector('iframe[rel="wangpan"]')}initialize(){return this.context=document.querySelector('iframe[rel="wangpan"]').contentDocument,n.init(),n.addMenu(this.context.querySelector("#js_top_panel_box"),"afterbegin"),this.context.querySelector(".right-tvf").style.display="block",this.addMenuButtonEventListener(),n.addContextMenuRPCSectionWithCallback((()=>{this.addContextMenuEventListener()})),t.showToast("初始化成功!","inf"),this}startListen(){const e=e=>{e.forEach((e=>{e.isdir?this.addFolder(e):this.addFile(e)})),this.start(t.getConfigData("interval"),(e=>{if("RPC"===this.mode&&t.aria2RPCMode(this.rpcURL,e),"TXT"===this.mode&&(t.aria2TXTMode(e),document.querySelector("#textMenu").classList.add("open-o")),"OPEN"===this.mode)for(const t of e)window.open("https://115.com/?ct=play&ac=location&pickcode="+t.pickcode)}))};window.addEventListener("message",(n=>{const s=n.data.type;if(s&&("selected"===s||"hovered"===s)){this.reset();const s=n.data.data;if(0===s.length)return void t.showToast("请选择一下你要保存的文件哦","war");e(s)}})),this.iframe.addEventListener("load",(()=>{this.initialize(),window.postMessage({type:"refresh"},location.origin)}))}addMenuButtonEventListener(){this.context.querySelector("#aria2List").addEventListener("click",(e=>{const t=e.target.dataset.url;t&&(this.rpcURL=t,this.getSelected(),this.mode="RPC"),"aria2Text"===e.target.id&&(this.getSelected(),this.mode="TXT"),"batchOpen"===e.target.id&&(this.getSelected(),this.mode="OPEN")}))}addContextMenuEventListener(){this.context.querySelector("#more-menu-rpc-section").addEventListener("click",(e=>{const t=e.target.dataset.url;t&&(this.rpcURL=t,this.getHovered(),this.mode="RPC")}))}getSelected(){window.postMessage({type:"getSelected"},location.origin)}getHovered(){window.postMessage({type:"getHovered"},location.origin)}getFile(e){return t.getConfigData("vip")?this.getFileFromProAPI(e):this.getFileFromWebAPI(e)}getFileFromWebAPI(e){const n={credentials:"include",method:"GET"};return new Promise((s=>{t.sendToBackground("fetch",{url:`${location.protocol}//webapi.115.com/files/download?pickcode=${e}`,options:n},(n=>{if(n.file_url){const e=n.file_url.match(/.*115.com(\/.*\/)/)[1];t.requestCookies([{path:e}]).then((e=>{n.cookies=e,s(n)}))}else t.showToast("无法获取下载地址!","err"),s(e)}))}))}getFileFromProAPI(e){const n=Date.now(),s=Math.floor(n/1e3),{data:i,key:o}=r.encode(JSON.stringify({pickcode:e}),s),a={headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include",method:"POST",body:`data=${encodeURIComponent(i)}`};return new Promise((n=>{t.sendToBackground("fetch",{url:`https://proapi.115.com/app/chrome/downurl?t=${s}`,options:a},(s=>{if(s.state){const i=JSON.parse(r.decode(s.data,o)),a=Object.values(i).pop();if(a.pickcode=a.pick_code,a.file_url=a.url.url,a.file_url){const e=a.file_url.match(/.*115.com(\/.*\/)/)[1];t.requestCookies([{path:e}]).then((e=>{a.cookies=e,n(a)}))}else t.showToast("无法获取下载地址!","err"),n(e)}else n(e)}))}))}getFiles(e){const t=Object.keys(e).map((e=>this.getFile(e)));return new Promise((n=>{Promise.all(t).then((t=>{t.forEach((t=>{this.isObject(t)?this.fileDownloadInfo.push({name:e[t.pickcode].path+t.file_name,link:t.file_url,size:t.file_size,sha1:e[t.pickcode].sha1,cookies:t.cookies,pickcode:t.pickcode}):console.log(e[t])})),n()}))}))}isObject(e){return null!==e&&"object"==typeof e}}).initialize().startListen()}();